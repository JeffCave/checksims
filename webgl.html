<!doctype html>
<html lang="en">
 <head>
  <meta charset="utf-8">
  <title>WebGL Demo</title>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/gpu.js/1.10.4/gpu.min.js'></script>
  <style>
	canvas{
		border:2px solid black;
	}
  </style>
 </head>

 <body>
  <canvas></canvas>
  <script>
	class CompareRecord{
		constructor(init=new Uint8Array([0,0,0,0, 0,0,0,0, 0,0,0,0])){
			this._values = new Uint8Array(init);

			this.LEX_A = 0;
			this.LEX_A1 = 1;
			this.LEX_B = 2;
			this.LEX_B1 = 3;
			this.SCORE = 4;
			this.DIR   = 5;
			this.TOTAL = 6;
			this.NORTH     = 8;
			this.EAST      = 9;
			this.NORTHEAST = 10;

			this.Width = 12; // bytes

		}
		get values(){
			return this._values;
		}
		set values(vals){
			this._values = vals;
		}
		get lexA(){
			let a = this.values[this.LEX_A] + (this.values[this.LEX_A+1]*256);
			return a;
		}
		set lexA(val){
			this.values[this.LEX_A]  = Math.floor(val%256);
			this.values[this.LEX_A+1] = Math.floor(val/256);
		}

		get lexB(){
			let a = this.values[this.LEX_B] + (this.values[this.LEX_B+1]*256);
			return a;
		}
		set lexB(val){
			this.values[this.LEX_B]  = Math.floor(val%256);
			this.values[this.LEX_B+1] = Math.floor(val/256);
		}

		get score(){return this.values[this.SCORE];}
		set score(val){this.values[this.SCORE] = val;}

		get dir(){return this.values[this.DIR];}
		set dir(val){this.values[this.DIR] = val;}

		get total(){return this.values[this.TOTAL];}
		set total(val){this.values[this.TOTAL] = val;}

		get north(){return this.values[this.NORTH];}
		set north(val){this.values[this.NORTH] = val;}

		get east(){return this.values[this.EAST];}
		set east(val){this.values[this.EAST] = val;}

		get northeast(){return this.values[this.NORTHEAST];}
		set northeast(val){this.values[this.NORTHEAST] = val;}
	}


	window.addEventListener('load',()=>{
		const canvas = document.querySelector('canvas');
		//const canvas = new OffscreenCanvas(7, 1);
		const gpu = new GPU({ canvas: canvas });
		const gl = null;//canvas.getContext('webgl');

		let submissions = [
				'PELLICAN'  .split('').map(c=>{return c.charCodeAt(0);}),
				'COELACANTH'.split('').map(c=>{return c.charCodeAt(0);}).reverse(),
			];

		// initialize the calculations.
		let inputs = {
			a:submissions[0].slice(0,7), //@X
			b:submissions[1].slice(0,7), //@Y
			    x:[  0,  1,  2,  3,  4,  5,  6], //X
			    y:[  0,  1,  2,  3,  4,  5,  6], //Y
			score:[  0,  0,  1,  1,  0,  0,  0], //Score
			  dir:[  0,  0,  0,  0,  0,  0,  0], //Dir
			total:[  0,  1,  2,  0,  0,  0,  0], //Total
			    n:[  0,  1,  2,  0,  0,  0,  0], //2 (N)
			    e:[  0,  0,  1,  2,  0,  0,  0], //1 (E)
			   nw:[  0,  0,  0,  0,  0,  1,  0], //0 (NW)
		};
		canvas.width  = 3;
		canvas.height = 7;


		/** direct **/
		function gCalc() {
			this.color(this.thread.x / this.output.x, this.thread.y / this.output.y, 1, 1);
		}

		const calc = gpu
			.createKernel(gCalc)
			.setGraphical(true)
			//.setOutputToTexture(true)
			.setOutput([canvas.width, canvas.height])
			;

		function setNumbersKernel(x,y,height,width,texture) {
			if(this.thread.x < x || this.thread.x > x+width){
				return;
			}
			if(this.thread.y < y || this.thread.y > y+height){
				return;
			}
			const pixel = texture[this.thread.x-x][this.thread.y-y];
			this.color(pixel[0],pixel[1],pixel[2],pixel[3]);
		}
		const setNumbers = gpu
			.createKernel(setNumbersKernel)
			.setOutput([canvas.width, canvas.height])
			;
/*
		const setNumbers = (x,y,height,width,pixels)=>{
			const level = 0;
			const internalFormat = gl.RGBA;
			const border = 0;
			const srcFormat = gl.RGBA;
			const srcType = gl.UNSIGNED_BYTE;
			const texture = gl.createTexture();
			gl.bindTexture(gl.TEXTURE_2D, texture);
			gl.texImage2D(gl.TEXTURE_2D, level, internalFormat, width, height, border, srcFormat, srcType, pixels);
		}
*/
		function incrementCalcKernel(x,y,height,width,texture) {
			if(this.thread.x < x || this.thread.x > x+width){
				return;
			}
			if(this.thread.y < y || this.thread.y > y+height){
				return;
			}
			const pixel = texture[this.thread.x-x][this.thread.y-y];
			this.color(pixel[0],pixel[1],pixel[2],pixel[3]);
		}
		const incrementCalc = gpu
			.createKernel(incrementCalcKernel)
			.setOutput([canvas.width, canvas.height])
			;


		function getNumbers(gpu){
			const gl = gpu.getCanvas().getContext('webgl');
			let pixels = new Uint8Array(gl.drawingBufferWidth * gl.drawingBufferHeight * 4);
			gl.readPixels(0, 0, gl.drawingBufferWidth, gl.drawingBufferHeight, gl.RGBA, gl.UNSIGNED_BYTE, pixels);
			return pixels;
		}


		/* Actually do stuff */
		calc();
		let buff = getNumbers(gpu);
		let rec = new CompareRecord();
		for(let x=0; x<canvas.height; x++){
			rec.values = new Uint8ClampedArray(buff.buffer,x*rec.Width,12);
			rec.lexA = inputs.a[x];
			rec.lexB = inputs.b[x];
			rec.score = inputs.score[x];
			rec.dir = inputs.dir[x];
			rec.total = inputs.total[x];
			rec.n = inputs.n[x];
			rec.e = inputs.e[x];
			rec.nw = inputs.nw[x];
		}
		setNumbers(0,0,canvas.height,canvas.width,buff);
		buff = getNumbers();

	});
  </script>
 </body>

</html>
